<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <!-- BOOTSTRAP CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Mes missions accept√©es</title>
</head>
<body>

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">üöö Mes missions accept√©es</h2>

    <!-- Display Propositions (Collections) -->
    <h4 class="mb-3 text-primary">üì¶ Collectes √† effectuer</h4>
    {% if propositions %}
        {% for proposition in propositions %}
        <div class="card mb-3 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <h5 class="card-title mb-3">
                        Proposition #{{ proposition.id }} - {{ proposition.type_materiel }}
                    </h5>
                    <span class="badge bg-primary">Collecte</span>
                </div>

                <p><strong>Quantit√© :</strong> {{ proposition.quantite }}</p>
                <p><strong>√âtat :</strong> {{ proposition.get_etat_display }}</p>
                <p><strong>Description :</strong> {{ proposition.description }}</p>
                <p>
                    <strong>Adresse de ramassage :</strong><br>
                    {{ proposition.adresse_ramassage }},<br>
                    {{ proposition.ville }} {{ proposition.code_postal }}
                </p>
                <p><strong>Disponibilit√© :</strong> {{ proposition.disponibilite_ramassage }}</p>
                <p><strong>Statut :</strong> 
                    <span class="badge {% if proposition.statut == 'terminee' %}bg-success{% elif proposition.statut == 'validee' %}bg-info{% else %}bg-warning{% endif %}">
                        {{ proposition.get_statut_display }}
                    </span>
                </p>
                <p><strong>Statut Transporteur :</strong> {{ proposition.get_transporteur_statut_display }}</p>

                {% if proposition.statut == 'validee' and proposition.transporteur_statut == 'acceptee' %}
                    <form method="post" action="{% url 'terminer_proposition' proposition.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success">
                            ‚úÖ Marquer comme termin√©e
                        </button>
                    </form>
                {% elif proposition.statut == 'terminee' %}
                    <p class="text-success fw-bold">‚úÖ Mission termin√©e</p>
                {% elif proposition.statut == 'validee' and proposition.transporteur_statut == 'en_attente' %}
                    <p class="text-warning">‚è≥ En attente de votre r√©ponse</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info">Aucune collecte √† effectuer.</div>
    {% endif %}

    <!-- Display Demandes (Deliveries) -->
    <h4 class="mb-3 text-success mt-5">üöö Livraisons √† effectuer</h4>
    {% if demandes %}
        {% for demande in demandes %}
        <div class="card mb-3 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <h5 class="card-title mb-3">
                        Demande #{{ demande.id }} - {{ demande.type_materiel }}
                    </h5>
                    <span class="badge bg-success">Livraison</span>
                </div>

                <p><strong>Cat√©gorie :</strong> {{ demande.categorie_recherchee.nom }}</p>
                <p><strong>Quantit√© d√©sir√©e :</strong> {{ demande.quantite_desiree }}</p>
                <p><strong>Description du besoin :</strong> {{ demande.description_besoin }}</p>
                <p><strong>Urgence :</strong> {{ demande.get_urgence_display }}</p>
                <p>
                    <strong>Adresse de livraison :</strong><br>
                    {{ demande.adresse_livraison }},<br>
                    {{ demande.ville }} {{ demande.code_postal }}
                </p>
                <p><strong>Disponibilit√© :</strong> {{ demande.disponibilite_livraison|default:"Non sp√©cifi√©e" }}</p>
                <p><strong>Statut :</strong> 
                    <span class="badge {% if demande.statut == 'terminee' %}bg-success{% elif demande.statut == 'validee' %}bg-info{% else %}bg-warning{% endif %}">
                        {{ demande.get_statut_display }}
                    </span>
                </p>
                <p><strong>Transporteur a confirm√© :</strong> 
                    {% if demande.transporteur_confirme %}
                        <span class="text-success">‚úÖ Oui</span>
                    {% else %}
                        <span class="text-warning">‚ùå Non</span>
                    {% endif %}
                </p>

                {% if demande.statut == 'validee' and not demande.transporteur_confirme %}
                    <a href="{% url 'transporteur_confirme_demande' demande.id %}" class="btn btn-primary">
                        üîÑ Confirmer/Refuser la mission
                    </a>
                {% elif demande.transporteur_confirme and demande.statut == 'validee' %}
                    <form method="post" action="{% url 'marquer_demande_terminee' demande.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success" name="action" value="marquer comme terminer">
                            ‚úÖ Marquer comme termin√©e
                        </button>
                    </form>
                {% elif demande.statut == 'terminee' %}
                    <p class="text-success fw-bold">‚úÖ Mission termin√©e</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info">Aucune livraison √† effectuer.</div>
    {% endif %}

    <!-- If no missions at all -->
    {% if not propositions and not demandes %}
        <div class="alert alert-info">
            <h5>Aucune mission accept√©e.</h5>
            <p>Vos missions appara√Ætront ici une fois que vous les aurez accept√©es.</p>
            <a href="{% url 'transporteur_notifications' %}" class="btn btn-primary">Voir mes notifications</a>
        </div>
    {% endif %}
</div>
{% endblock %}

<!-- BOOTSTRAP JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>