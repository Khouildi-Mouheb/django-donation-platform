{% extends 'base/base.html' %}
{% load static %}

{% block title %}Créer une Demande de Don | DonationHub{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="dashboard-header mb-5">
        <h1 class="display-5 fw-bold">
            <i class="fas fa-hand-holding-heart me-2"></i> Créer une demande de don
        </h1>
        <p class="lead text-muted">Décrivez ce dont vous avez besoin, nous trouverons un donateur</p>
    </div>

    <div class="row">
        <!-- Left Column - Form -->
        <div class="col-lg-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-edit me-2"></i> Formulaire de demande
                    </h4>
                </div>
                
                <div class="card-body">
                    {% if messages %}
                    <div class="alert-container mb-4">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            <i class="fas 
                                {% if message.tags == 'success' %}fa-check-circle
                                {% elif message.tags == 'error' %}fa-exclamation-circle
                                {% else %}fa-info-circle{% endif %}
                                me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <form method="post" id="demandeForm" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Form Sections with Steps -->
                        <div class="form-steps mb-4">
                            <div class="step-indicator">
                                <div class="step active" data-step="1">
                                    <span class="step-number">1</span>
                                    <span class="step-label">Informations de base</span>
                                </div>
                                <div class="step" data-step="2">
                                    <span class="step-number">2</span>
                                    <span class="step-label">Détails du besoin</span>
                                </div>
                                <div class="step" data-step="3">
                                    <span class="step-number">3</span>
                                    <span class="step-label">Livraison</span>
                                </div>
                            </div>
                        </div>

                        <!-- Step 1: Basic Information -->
                        <div class="form-step active" id="step1">
                            <h5 class="fw-bold text-primary mb-4">
                                <i class="fas fa-info-circle me-2"></i> Informations de base
                            </h5>
                            
                            <div class="row">
                                <!-- Category -->
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.categorie_recherchee.id_for_label }}" class="form-label fw-bold">
                                        <i class="fas fa-tag me-1"></i> Catégorie recherchée *
                                    </label>
                                    {{ form.categorie_recherchee }}
                                    {% if form.categorie_recherchee.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.categorie_recherchee.errors }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">Sélectionnez la catégorie d'objets dont vous avez besoin</div>
                                </div>

                                <!-- Type of Material -->
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.type_materiel.id_for_label }}" class="form-label fw-bold">
                                        <i class="fas fa-box me-1"></i> Type de matériel *
                                    </label>
                                    {{ form.type_materiel }}
                                    {% if form.type_materiel.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.type_materiel.errors }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">Ex: Meuble, électroménager, vêtement, etc.</div>
                                </div>

                                <!-- Desired Quantity -->
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.quantite_desiree.id_for_label }}" class="form-label fw-bold">
                                        <i class="fas fa-balance-scale me-1"></i> Quantité désirée *
                                    </label>
                                    {{ form.quantite_desiree }}
                                    {% if form.quantite_desiree.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.quantite_desiree.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Urgency -->
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.urgence.id_for_label }}" class="form-label fw-bold">
                                        <i class="fas fa-exclamation-triangle me-1"></i> Niveau d'urgence *
                                    </label>
                                    {{ form.urgence }}
                                    {% if form.urgence.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.urgence.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Condition -->
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.etat_souhaite.id_for_label }}" class="form-label fw-bold">
                                        <i class="fas fa-star me-1"></i> État souhaité *
                                    </label>
                                    {{ form.etat_souhaite }}
                                    {% if form.etat_souhaite.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.etat_souhaite.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Need Details -->
                        <div class="form-step" id="step2" style="display: none;">
                            <h5 class="fw-bold text-primary mb-4">
                                <i class="fas fa-align-left me-2"></i> Détails du besoin
                            </h5>
                            
                            <!-- Description -->
                            <div class="mb-4">
                                <label for="{{ form.description_besoin.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-file-alt me-1"></i> Description détaillée du besoin *
                                </label>
                                {{ form.description_besoin }}
                                {% if form.description_besoin.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.description_besoin.errors }}
                                </div>
                                {% endif %}
                                <div class="form-text">
                                    Décrivez précisément ce dont vous avez besoin, incluant dimensions, spécificités, etc.
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted" id="descriptionCounter">0 / 500 caractères</small>
                                </div>
                            </div>

                            <!-- Specific Requirements -->
                            <div class="mb-3">
                                <label for="{{ form.exigences_specifiques.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-clipboard-check me-1"></i> Exigences spécifiques (optionnel)
                                </label>
                                {{ form.exigences_specifiques }}
                                {% if form.exigences_specifiques.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.exigences_specifiques.errors }}
                                </div>
                                {% endif %}
                                <div class="form-text">Précisez des contraintes particulières (couleur, marque, etc.)</div>
                            </div>
                        </div>

                        <!-- Step 3: Delivery Information -->
                        <div class="form-step" id="step3" style="display: none;">
                            <h5 class="fw-bold text-primary mb-4">
                                <i class="fas fa-truck me-2"></i> Informations de livraison
                            </h5>
                            
                            <div class="row">
                                <!-- Delivery Address -->
                                <div class="col-md-12 mb-3">
                                    <label for="{{ form.adresse_livraison.id_for_label }}" class="form-label fw-bold">
                                        <i class="fas fa-map-marker-alt me-1"></i> Adresse de livraison *
                                    </label>
                                    {{ form.adresse_livraison }}
                                    {% if form.adresse_livraison.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.adresse_livraison.errors }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">Adresse complète où le don doit être livré</div>
                                </div>

                                <!-- City -->
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.ville.id_for_label }}" class="form-label fw-bold">
                                        <i class="fas fa-city me-1"></i> Ville *
                                    </label>
                                    {{ form.ville }}
                                    {% if form.ville.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.ville.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Postal Code -->
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.code_postal.id_for_label }}" class="form-label fw-bold">
                                        <i class="fas fa-mail-bulk me-1"></i> Code postal *
                                    </label>
                                    {{ form.code_postal }}
                                    {% if form.code_postal.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.code_postal.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Delivery Availability -->
                                <div class="col-md-12 mb-3">
                                    <label for="{{ form.disponibilite_livraison.id_for_label }}" class="form-label fw-bold">
                                        <i class="fas fa-calendar-alt me-1"></i> Disponibilité pour livraison *
                                    </label>
                                    {{ form.disponibilite_livraison }}
                                    {% if form.disponibilite_livraison.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.disponibilite_livraison.errors }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">Précisez vos disponibilités pour recevoir le don</div>
                                </div>

                                <!-- Contact Phone -->
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.telephone_contact.id_for_label }}" class="form-label fw-bold">
                                        <i class="fas fa-phone me-1"></i> Téléphone de contact *
                                    </label>
                                    {{ form.telephone_contact }}
                                    {% if form.telephone_contact.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.telephone_contact.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Additional Notes -->
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.notes_livraison.id_for_label }}" class="form-label fw-bold">
                                        <i class="fas fa-sticky-note me-1"></i> Notes pour la livraison (optionnel)
                                    </label>
                                    {{ form.notes_livraison }}
                                    {% if form.notes_livraison.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.notes_livraison.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="form-navigation mt-5 pt-4 border-top">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" id="prevBtn" style="display: none;">
                                    <i class="fas fa-arrow-left me-2"></i> Retour
                                </button>
                                
                                <div class="ms-auto">
                                    <button type="button" class="btn btn-primary" id="nextBtn">
                                        Suivant <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                    
                                    <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                                        <i class="fas fa-paper-plane me-2"></i> Soumettre la demande
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column - Help & Info -->
        <div class="col-lg-4">
            <!-- Tips Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i> Conseils pour une bonne demande
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-3">
                            <div class="d-flex">
                                <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                                <div>
                                    <strong>Soyez précis</strong>
                                    <p class="small mb-0">Décrivez clairement ce dont vous avez besoin</p>
                                </div>
                            </div>
                        </li>
                        <li class="mb-3">
                            <div class="d-flex">
                                <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                                <div>
                                    <strong>Indiquez l'urgence</strong>
                                    <p class="small mb-0">Cela aide les donateurs à prioriser</p>
                                </div>
                            </div>
                        </li>
                        <li class="mb-3">
                            <div class="d-flex">
                                <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                                <div>
                                    <strong>Précisez vos disponibilités</strong>
                                    <p class="small mb-0">Facilite la coordination avec les transporteurs</p>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div class="d-flex">
                                <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                                <div>
                                    <strong>Vérifiez vos informations</strong>
                                    <p class="small mb-0">Assurez-vous que les coordonnées sont exactes</p>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Status Card -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i> À propos du processus
                    </h5>
                </div>
                <div class="card-body">
                    <div class="process-timeline">
                        <div class="process-step mb-3">
                            <div class="step-icon bg-primary">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="step-content">
                                <h6 class="fw-bold mb-1">1. Soumission</h6>
                                <p class="small mb-0">Vous créez votre demande</p>
                            </div>
                        </div>
                        
                        <div class="process-step mb-3">
                            <div class="step-icon bg-warning">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="step-content">
                                <h6 class="fw-bold mb-1">2. Validation</h6>
                                <p class="small mb-0">Un membre valide votre demande</p>
                            </div>
                        </div>
                        
                        <div class="process-step mb-3">
                            <div class="step-icon bg-info">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="step-content">
                                <h6 class="fw-bold mb-1">3. Recherche</h6>
                                <p class="small mb-0">Nous cherchons un don correspondant</p>
                            </div>
                        </div>
                        
                        <div class="process-step">
                            <div class="step-icon bg-success">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="step-content">
                                <h6 class="fw-bold mb-1">4. Livraison</h6>
                                <p class="small mb-0">Un transporteur vous livre le don</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .dashboard-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-top: 1rem;
    }
    
    .card {
        border-radius: 12px;
        overflow: hidden;
    }
    
    .card-header {
        padding: 1.2rem 1.5rem;
        border-bottom: none;
    }
    
    .form-steps {
        margin-bottom: 2rem;
    }
    
    .step-indicator {
        display: flex;
        justify-content: space-between;
        position: relative;
    }
    
    .step-indicator::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 0;
        right: 0;
        height: 2px;
        background-color: #e0e0e0;
        z-index: 1;
    }
    
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
        flex: 1;
    }
    
    .step-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #e0e0e0;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .step.active .step-number {
        background-color: #007bff;
        color: white;
        transform: scale(1.1);
    }
    
    .step-label {
        font-size: 0.85rem;
        font-weight: 500;
        color: #666;
        text-align: center;
    }
    
    .step.active .step-label {
        color: #007bff;
        font-weight: 600;
    }
    
    .form-step {
        animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Form styling */
    .form-control, .form-select {
        border-radius: 8px;
        padding: 0.75rem 1rem;
        border: 1px solid #ced4da;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.25rem rgba(0,123,255,0.25);
        transform: translateY(-1px);
    }
    
    textarea.form-control {
        min-height: 120px;
        resize: vertical;
    }
    
    /* Process timeline */
    .process-step {
        display: flex;
        align-items: flex-start;
    }
    
    .step-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .step-content {
        padding-top: 0.3rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .step-label {
            font-size: 0.75rem;
        }
        
        .dashboard-header {
            padding: 1.5rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentStep = 1;
        const totalSteps = 3;
        
        // Initialize form fields styling
        initializeFormFields();
        
        // Character counter for description
        const descriptionField = document.getElementById('{{ form.description_besoin.id_for_label }}');
        const descriptionCounter = document.getElementById('descriptionCounter');
        
        if (descriptionField && descriptionCounter) {
            descriptionField.addEventListener('input', function() {
                const length = this.value.length;
                descriptionCounter.textContent = `${length} / 500 caractères`;
                
                if (length > 500) {
                    descriptionCounter.classList.add('text-danger');
                } else {
                    descriptionCounter.classList.remove('text-danger');
                }
            });
            
            // Initialize counter
            descriptionField.dispatchEvent(new Event('input'));
        }
        
        // Step navigation
        document.getElementById('nextBtn').addEventListener('click', nextStep);
        document.getElementById('prevBtn').addEventListener('click', prevStep);
        
        // Form submission
        document.getElementById('demandeForm').addEventListener('submit', function(e) {
            // Validate all steps before submission
            if (!validateAllSteps()) {
                e.preventDefault();
                return false;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Soumission en cours...';
            submitBtn.disabled = true;
        });
        
        function initializeFormFields() {
            // Add Bootstrap classes to Django form fields
            document.querySelectorAll('select, input, textarea').forEach(field => {
                if (!field.classList.contains('form-control') && !field.classList.contains('form-select')) {
                    if (field.tagName === 'SELECT') {
                        field.classList.add('form-select');
                    } else if (field.tagName === 'TEXTAREA') {
                        field.classList.add('form-control');
                    } else {
                        field.classList.add('form-control');
                    }
                }
            });
        }
        
        function nextStep() {
            if (!validateStep(currentStep)) {
                return;
            }
            
            if (currentStep < totalSteps) {
                // Hide current step
                document.getElementById(`step${currentStep}`).style.display = 'none';
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
                
                // Show next step
                currentStep++;
                document.getElementById(`step${currentStep}`).style.display = 'block';
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
                
                // Update navigation buttons
                updateNavigationButtons();
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                // Hide current step
                document.getElementById(`step${currentStep}`).style.display = 'none';
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
                
                // Show previous step
                currentStep--;
                document.getElementById(`step${currentStep}`).style.display = 'block';
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
                
                // Update navigation buttons
                updateNavigationButtons();
            }
        }
        
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            // Show/hide previous button
            if (currentStep > 1) {
                prevBtn.style.display = 'block';
            } else {
                prevBtn.style.display = 'none';
            }
            
            // Show/hide next and submit buttons
            if (currentStep === totalSteps) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            }
        }
        
        function validateStep(step) {
            let isValid = true;
            
            // Get all required fields in current step
            const currentStepElement = document.getElementById(`step${step}`);
            const requiredFields = currentStepElement.querySelectorAll('[required]');
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    
                    // Add error message
                    if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('invalid-feedback')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback d-block';
                        errorDiv.textContent = 'Ce champ est obligatoire';
                        field.parentNode.insertBefore(errorDiv, field.nextSibling);
                    }
                    
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                    
                    // Remove error message
                    const errorDiv = field.nextElementSibling;
                    if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                        errorDiv.remove();
                    }
                }
            });
            
            // Scroll to first error
            if (!isValid) {
                const firstError = currentStepElement.querySelector('.is-invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
            }
            
            return isValid;
        }
        
        function validateAllSteps() {
            let allValid = true;
            
            for (let i = 1; i <= totalSteps; i++) {
                if (!validateStep(i)) {
                    allValid = false;
                    
                    // Jump to step with error
                    if (currentStep !== i) {
                        // Hide current step
                        document.getElementById(`step${currentStep}`).style.display = 'none';
                        document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
                        
                        // Show error step
                        currentStep = i;
                        document.getElementById(`step${currentStep}`).style.display = 'block';
                        document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
                        updateNavigationButtons();
                    }
                    
                    break;
                }
            }
            
            return allValid;
        }
        
        // Initialize navigation buttons
        updateNavigationButtons();
    });
</script>
{% endblock %}