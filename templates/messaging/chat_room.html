<!-- messaging/templates/messaging/chat_room.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Chat avec {{ receiver.get_full_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #messages {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f8f9fa;
        }
        .message-sent { text-align: right; color: white; background-color: #0d6efd; padding:5px 10px; border-radius: 10px; margin:5px 0; display:inline-block; }
        .message-received { text-align: left; color: white; background-color: #6c757d; padding:5px 10px; border-radius: 10px; margin:5px 0; display:inline-block; }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2>ðŸ’¬ Chat avec {{ receiver.username }}</h2>

    <div id="messages" class="mb-3">
    {% for msg in messages %}
        {% if msg.sender == user %}
            <div class="message-sent">
                <strong>{{ msg.sender.username }}:</strong> {{ msg.text }}
                
            </div>
            <br>
        {% else %}
            <div class="message-received">
                <strong>{{ msg.sender.username }}:</strong> {{ msg.text }}
                
            </div>
            <br>
        {% endif %}
    {% endfor %}
</div>


    <div class="input-group">
        <input type="text" id="messageInput" class="form-control" placeholder="Tapez votre message...">
        <button class="btn btn-primary" onclick="sendMessage()">Envoyer</button>
    </div>
</div>

<script>
const userId = {{ user.id }};
const receiverId = {{ receiver.id }};
const messagesDiv = document.getElementById("messages");

const ws = new WebSocket(`ws://127.0.0.1:9000/ws/chat/${userId}`);

ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    const div = document.createElement("div");
    div.className = data.sender_id == userId ? "message-sent" : "message-received";
    div.innerHTML = `<strong>${data.sender_username}:</strong> ${data.text}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
};

function sendMessage() {
    const text = document.getElementById("messageInput").value;
    if (!text) return;
    ws.send(JSON.stringify({
        sender_id: userId,
        receiver_id: receiverId,
        sender_username: "{{ user.username }}",
        text: text
    }));
    document.getElementById("messageInput").value = "";
}
</script>
</body>
</html>
